<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
    .angular-google-map-container {
        height: 600px;
        width: 600px;
    }
    
    .marker-labels {
        color: white;
        font-family: "Lucida Grande", "Arial", sans-serif;
        font-size: 10px;
        text-shadow: 0px 0px 3px rgba(0, 0, 0, 1);
        text-align: center;
        white-space: nowrap;
    }
    
    #primary::after {
        content: "";
        display: block;
        clear: both;
    }
    
    #primary > div {
        float: left;
    }
    </style>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/lodash/lodash.js"></script>
    <script src="http://cdn.rawgit.com/nmccready/angular-simple-logger/0.0.1/dist/index.js"></script>
    <script src="dist/angular-google-maps_dev_mapped.js"></script>
    <script>
    function getNormalizedCoord(coord, zoom) {
        var y = coord.y;
        var x = coord.x;
        var tileRange = 1 << zoom;
        if (y < 0 || y >= tileRange) {
            return null;
        }
        if (x < 0 || x >= tileRange) {
            x = (x % tileRange + tileRange) % tileRange;
        }
        return {
            x: x,
            y: y
        };
    }

    angular.module("markerCoordsTest", ['uiGmapgoogle-maps'])
        .config(['uiGmapGoogleMapApiProvider', function(GoogleMapApi) {
            GoogleMapApi.configure({
                v: '3',
                libraries: '',
                key: 'AIzaSyB4iF-sbQ8jILkuFHfvcNSkytxmtkzppYA'
            });
        }])
        .controller('abcd', ["$scope", "uiGmapGoogleMapApi", function($scope, uiGmapGoogleMapApi) {
            var _self = this;

            var dataFormat = {
                id: null,
                coords: {
                    latitude: 40.1451,
                    longitude: -99.6680
                },
                options: {
                    labelContent: null,
                    labelAnchor: "0 0",
                    labelClass: "marker-labels",
                    hideRange: 4
                }
            }

            _self.editData = null;

            _self.addProcess = function() {
                _self.editData = angular.copy(dataFormat);
            }

            uiGmapGoogleMapApi.then(function(maps) {
                //console.log(new maps.Size(256, 256));

                _self.moonMapType = {
                    getTileUrl: function(coord, zoom) {
                        var normalizedCoord = getNormalizedCoord(coord, zoom);
                        if (!normalizedCoord) {
                            return null;
                        }

                        switch (zoom) {
                            case 1:
                                if (normalizedCoord.x == 1) {
                                    return null;
                                }
                                break;

                            case 2:
                                if (normalizedCoord.x > 1 || normalizedCoord.y > 2) {
                                    return null;
                                }
                                break;

                            case 3:
                                if (normalizedCoord.x > 2 || normalizedCoord.y > 5) {
                                    return null;
                                }
                                break;

                            case 4:
                                if (normalizedCoord.x > 5 || normalizedCoord.y > 11) {
                                    return null;
                                }
                                break;
                        }

                        var bound = Math.pow(2, zoom);
                        return 'tile' +
                            '/' + zoom + '/' + normalizedCoord.x + '/' +
                            (normalizedCoord.y) + '.png';
                    },
                    tileSize: new maps.Size(256, 256),
                    maxZoom: 4,
                    minZoom: 2,
                    name: 'moon'
                };


            });

            _self.map = {
                title: "A test map",
                center: {
                    latitude: 49.1529,
                    longitude: -119.1796
                },
                zoom: 2,
                options: {
                    mapTypeId: 'moon',
                    mapTypeControlOptions: {
                        mapTypeIds: ['moon']
                    },
                    disableDefaultUI: true
                },
                events: {
                    click: function(mapModel, eventName, originalEventArgs) {
                        /* var e = originalEventArgs[0];
                         // console.log(e.getCenter().lat()+"/"+e.getCenter().lng());
                         // console.log(e.latLng.lat() + "/" + e.latLng.lng());
                         _self.loc.lat = e.latLng.lat();
                         _self.loc.lng = e.latLng.lng();*/

                        if (_self.editData) {
                            var e = originalEventArgs[0];
                            _self.editData.coords.latitude = e.latLng.lat();
                            _self.editData.coords.longitude = e.latLng.lng();
                            $scope.$apply();
                        }


                    }
                }
            };

            _self.marker = [{
                id: 0,
                coords: {
                    latitude: 40.1451,
                    longitude: -99.6680
                },
                options: {
                    labelContent: "markerLabel with default 'coords'",
                    labelAnchor: "0 0",
                    labelClass: "marker-labels",
                    hideRange: 4
                }
            }]

            _self.addData = function(){
                _self.editData.id=1;
                  _self.marker.push(angular.copy(_self.editData));
            }

            _self.loc = {
                lat: null,
                lng: null
            }

        }])
    </script>
</head>

<body ng-app="markerCoordsTest">
    <div ng-controller="abcd as a" id="primary">
        <div>
            <ui-gmap-google-map class="gmap" center="a.map.center" zoom="a.map.zoom" options="a.map.options" events="a.map.events">
                <ui-gmap-marker ng-repeat="value in a.marker" coords="value.coords" options="value.options" idkey="value.id">
                </ui-gmap-marker>
                <ui-gmap-map-type id="moon" options="a.moonMapType">
                </ui-gmap-map-type>
            </ui-gmap-google-map>
        </div>
        <div>
            <button ng-click='a.addProcess()'>add</button>
            <table ng-if="a.editData">
                <tr>
                    <td>{{a.editData.coords.latitude}} / {{a.editData.coords.longitude}}</td>
                </tr>
                <tr>
                    <td>
                        <input type="text" ng-model="a.editData.options.labelContent">
                    </td>
                </tr>
                <tr>
                    <td>
                        <button ng-click="a.addData()">create</button>
                    </td>
                </tr>
            </table>{{a.editData}}
        </div>
    </div>
</body>

</html>
